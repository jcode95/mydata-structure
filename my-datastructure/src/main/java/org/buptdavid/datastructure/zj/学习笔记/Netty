                                Netty çš„å­¦ä¹ ç¬”è®°

ã€–Netty æœåŠ¡ç«¯åˆ›å»ºã€—
NioSocketChannel æ˜¯æ³¨å†Œæ–¹æ³•å’ŒServerSocketChannelçš„ä¸€è‡´ï¼Œä¹Ÿæ˜¯å°†Channelæ³¨å†Œåˆ°Reactorçº¿ç¨‹çš„å¤šè·¯å¤ç”¨å™¨ä¸Šã€‚
ç”±äºæ³¨å†Œçš„æ“ä½œä½æ˜¯0ï¼Œä¹Ÿå°±æ˜¯OP_ACCEPT,æ‰€ä»¥ï¼Œæ­¤æ—¶çš„NioSocketChannelè¿˜ä¸èƒ½è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œåªæœ‰åœ¨ç›‘å¬äº†OP_READæ“ä½œä½ä¹‹å
æ‰èƒ½è¯»å–ã€‚
é‚£ä»€ä¹ˆæ—¶å€™æ‰èƒ½ç›‘å¬OP_READæ“ä½œä½å‘¢ï¼Ÿ
    åœ¨æ‰§è¡Œå®Œæ³¨å†Œæ“ä½œä½ä¹‹åï¼Œç´§æ¥ç€ä¼šè§¦å‘ChannelReadCompleteäº‹ä»¶
    ChannelReadCompleteäº‹ä»¶åœ¨ChannelPipelineä¸­çš„å¤„ç†æµç¨‹ï¼š
        1ï¼ŒNettyçš„Headerå’ŒTailæœ¬èº«ä¸å…³å¿ƒChannelReadCompleteäº‹ä»¶å°±ç›´æ¥é€ä¼ ï¼Œæ‰§è¡Œå®ŒChannelReadCompleteä¹‹åï¼Œæ¥ç€æ‰§è¡Œ
        PipeLineçš„read() çš„æ–¹æ³•æœ€ç»ˆä¼šæ‰§è¡ŒHeadHandlerçš„read()æ–¹æ³•ã€‚HeadHandlerçš„read()æ–¹æ³•å°±æ˜¯å°†ç½‘ç»œæ“ä½œä½ä¿®æ”¹ä¸ºè¯»æ“ä½œ
        åˆ›å»ºNioSocketChannelçš„æ—¶å€™å·²å°†AbstractNioChannelçš„readInterestOpè®¾ç½®ä¸ºOP_READï¼Œè¿™æ ·ï¼Œæ‰§è¡ŒselectionKey.interestOps(interestOps|readInterestOp)æ“ä½œæ—¶
        å°±ä¼šæŠŠæ“ä½œä½è®¾ç½®ä¸ºOP_READã€‚æºç å¦‚ä¸‹ï¼š

          protected AbstractNioByteChannel(Channel parent, EventLoop eventLoop, SelectableChannel ch) {
                super(parent, eventLoop, ch, 1);
          }



ã€–Netty å®¢æˆ·ç«¯åˆ›å»ºã€—
   å®¢æˆ·ç«¯çš„åˆ›å»ºç›¸æ¯”æœåŠ¡ç«¯æ¯”è¾ƒå¤æ‚ï¼Œé™¤äº†è¦è€ƒè™‘çº¿ç¨‹æ¨¡å‹ï¼Œå¼‚æ­¥è¿æ¥ï¼Œå®¢æˆ·ç«¯è¿æ¥è¶…æ—¶ç­‰å› ç´ å¤–ï¼Œè¿˜éœ€è¦å¯¹è¿æ¥è¿‡ç¨‹ä¸­çš„å„ç§å¼‚å¸¸åšè€ƒè™‘ã€‚

   è¯´åˆ°Nettyçš„å®¢æˆ·ç«¯ï¼Œé‚£å°±ä¸èƒ½ä¸èŠèŠBootstrapå·¥å…·ç±»äº†ï¼Œç”¨æˆ·é€šè¿‡Bootstrapåˆ›å»ºå®¢æˆ·ç«¯å¹¶ä¸”å‘èµ·å¼‚æ­¥çš„tcpè¿æ¥æ“ä½œã€‚
   Netty å®¢æˆ·ç«¯åˆ›å»ºæµç¨‹ï¼š
   â¤ ç”¨æˆ·çº¿ç¨‹åˆ›å»ºBootstrapå®ä¾‹ï¼Œé€šè¿‡APIè®¾ç½®åˆ›å»ºå®¢æˆ·ç«¯ç›¸å…³å‚æ•°ï¼Œå¼‚æ­¥å‘èµ·å®¢æˆ·ç«¯è¿æ¥ã€‚
   â¤ åˆ›å»ºå¤„ç†å®¢æˆ·ç«¯è¿æ¥ï¼ŒI/O è¯»å†™çš„Reactorçº¿ç¨‹ç»„ï¼ˆNioEventLoopGroupï¼‰,å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æŒ‡å®šIOçº¿ç¨‹ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯CPUå†…æ ¸æ•°çš„2å€ã€‚
   â¤ é€šè¿‡Bootstrapçš„ChannelFactoryå’Œç”¨æˆ·æŒ‡å®šçš„Channelç±»å‹åˆ›å»ºç”¨äºå®¢æˆ·ç«¯è¿æ¥çš„NioSocketChannelï¼Œå®ƒçš„åŠŸèƒ½ç±»ä¼¼äºJDK NIO
        ç±»åº“æä¾›çš„SocketChannelã€‚
   â¤ åˆ›å»ºé»˜è®¤çš„Channel Handler Pipelineã€‚ç”¨äºè°ƒåº¦å’Œæ‰§è¡Œç½‘ç»œäº‹ä»¶ã€‚
   â¤ å¼‚æ­¥å‘èµ·TCPè¿æ¥ï¼Œåˆ¤æ–­æ˜¯å¦æˆåŠŸï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™ç›´æ¥å°†NIoSocketChannelæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œç›‘å¬è¯»æ“ä½œä½(OP_READ)ã€‚ç”¨äºæ•°æ®çš„è¯»å–å’Œå‘é€æ“ä½œï¼Œ
                                    å¦‚æœæ²¡æœ‰è¿æ¥æˆåŠŸï¼Œåˆ™æ³¨å†Œåˆ°ç›‘å¬è¿æ¥ï¼ˆOP_ACCEPTï¼‰æ“ä½œä½ä¸Šï¼Œç­‰å¾…è¿æ¥ç»“æœã€‚
   â¤ æ³¨å†Œå¯¹åº”çš„ç½‘ç»œç›‘å¬çŠ¶æ€ä½åˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šã€‚
   â¤ ç”±å¤šè·¯å¤ç”¨å™¨åœ¨IOçº¿ç¨‹ä¸­è½®è¯¢å„ä¸ªChannelï¼Œå¤„ç†è¿æ¥ç»“æœã€‚
   â¤ å¦‚æœè¿æ¥æˆåŠŸï¼Œè®¾ç½®Futureç»“æœï¼Œå‘é€æˆåŠŸäº‹ä»¶ï¼Œè§¦å‘ChannelPipelineçš„æ‰§è¡Œ
   â¤ ç”±ChannelPipelineè°ƒåº¦æ‰§è¡Œç³»ç»Ÿæˆ–è€…ç”¨æˆ·çš„ChannelHandler ,æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚

ã€–Netty æºç åˆ†æã€—
    ã€”ByteBufã€•
        ByteBuf æ˜¯é‡å†™äº†JDK NIO é‡Œé¢çš„ByteBufferï¼ŒåŸå› æ˜¯ByteBufferæœ‰å±€é™æ€§ï¼Œå¦‚ä¸‹:
                âœ ByteBufferé•¿åº¦å›ºå®šï¼Œä¸€æ—¦åˆ†é…å®Œæˆï¼Œå®ƒçš„å®¹é‡ä¸èƒ½åŠ¨æ€æ‰©å±•å’Œæ”¶ç¼©ï¼Œå½“ç¼–ç çš„æ•°æ®å¤§äºByteBufferçš„å®¹é‡æ—¶ï¼Œå°±ä¼šå‘ç”Ÿç´¢å¼•è¶Šç•Œå¼‚å¸¸ã€‚
                âœ ByteBufferåªæœ‰ä¸€ä¸ªæ ‡å¿—ä½ç½®çš„æŒ‡é’ˆposition,è¯»å†™çš„æ˜¯æ—¶å€™éœ€è¦å¼€å‘äººå‘˜æ‰‹åŠ¨çš„è°ƒç”¨flip()æ–¹æ³•å’Œrewind()æ–¹æ³•ã€‚

        ğŸ™ˆ
            JDK ByteBuff å›¾è§£ç¤ºæ„å›¾
            å…ˆçœ‹ä¸€ä¸‹ä»£ç 
            ByteBuffer byteBuffer = ByteBuffer.allocate(88);
            String str="hello world";
            byteBuffer.put(str.getBytes());
            byteBuffer.put("nihaoya".getBytes());
            byteBuffer.flip();
            byte[] bytes = new byte[byteBuffer.remaining()];
            byteBuffer.get(bytes);
            try {
                String readStr = new String(bytes, "UTF-8");
                System.out.println(readStr);
            } catch (UnsupportedEncodingException e) {
                e.printStackTrace();
            }

            æ‰§è¡Œflip()æ–¹æ³•ä¹‹å‰
            å†™å…¥çš„æ•°æ®åŒºåŸŸ   (position-limitå¯è¯»åŒºåŸŸ)  (limit-capacityå¯å†™åŒºåŸŸ)
            |________________|__________________|________________________________|
            0             position              limit                         capacity(æœ€å¤§å¼€è¾Ÿçš„ç©ºé—´ï¼Œå†™å…¥çš„æ•°æ®ä¸èƒ½è¶…è¿‡è¿™ä¸ªå€¼ï¼Œå¦åˆ™ä¼šæŠ›å‡ºæ•°ç»„è¶Šç•Œå¼‚å¸¸)

            æ‰§è¡Œflip()æ–¹æ³•ä¹‹å position=0ï¼Œ
              å†™å…¥çš„æ•°æ®åŒºåŸŸ
            |________________|___________________________________________________|
            0              limit                                              capacity(æœ€å¤§å¼€è¾Ÿçš„ç©ºé—´ï¼Œå†™å…¥çš„æ•°æ®ä¸èƒ½è¶…è¿‡è¿™ä¸ªå€¼ï¼Œå¦åˆ™ä¼šæŠ›å‡ºæ•°ç»„è¶Šç•Œå¼‚å¸¸)
         position=0
            JDK ByteBuffer æ€»æ˜¯è¯»å–æ˜¯ä»positionåˆ°limit ä¹‹é—´çš„æ•°æ®ï¼Œå¦‚æœè¯»å–ä¹‹å‰ä¸è°ƒç”¨flip()æ–¹æ³•ï¼Œå°±å¯èƒ½ä¼šå‡ºé—®é¢˜,å†™ä¹Ÿæ˜¯ä¸€æ ·ã€‚

        ğŸ™ˆ
            |________________|___________________________|________________________|
            0           readIndex                    writIndex                 capacity
           readIndexå’ŒwritIndexçš„å–å€¼ä¸€å¼€å§‹éƒ½æ˜¯0ï¼Œå½“æœ‰æ•°æ®å†™å…¥ï¼ŒwritIndexå¼€å§‹å¢åŠ ï¼ŒreadIndexä½ç½®ä¸å˜ï¼Œå½“è¯»å–æ•°æ®æ˜¯ï¼ŒreadIndexå¼€å§‹å¢åŠ ï¼ŒwritIndexä½ç½®ä¸åŠ¨
           0åˆ°readIndexä¹‹é—´çš„åŒºåŸŸæ˜¯å·²è¯»çš„åŒºåŸŸï¼ŒreadIndexåˆ°writIndexä¹‹é—´çš„åŒºåŸŸä¸ºå¯è¯»åŒºåŸŸï¼ŒwritIndexåˆ°capacityä¹‹é—´çš„åŒºåŸŸä¸ºå¯å†™åŒºåŸŸ

         ğŸ™ˆ Nettyå†…å­˜ç®¡ç†
          ã€1ã€‘ PoolArena Netty çš„å†…å­˜æ± å®ç°ç±»ã€‚
               Nettyçš„PoolArenaæ˜¯ç”±å¤šä¸ªChunkç»„æˆçš„å¤§å—å†…å­˜åŒºåŸŸï¼Œè€Œæ¯ä¸€ä¸ªChunkç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªpageç»„æˆã€‚
               æºç ï¼š
                    abstract class PoolArena<T> {
                        final PooledByteBufAllocator parent;
                        private final int pageSize;
                        private final int maxOrder;
                        private final int pageShifts;
                        private final int chunkSize;
                        private final int subpageOverflowMask;
                        private final PoolSubpage<T>[] tinySubpagePools;
                        private final PoolSubpage<T>[] smallSubpagePools;
                        private final PoolChunkList<T> q050;
                        private final PoolChunkList<T> q025;
                        private final PoolChunkList<T> q000;
                        private final PoolChunkList<T> qInit;
                        private final PoolChunkList<T> q075;
                        private final PoolChunkList<T> q100;

          ã€2ã€‘ Chunkä¸»è¦ç”¨æ¥ç®¡ç†pageçš„å†…å­˜çš„åˆ†é…ä¸é‡Šæ”¾ã€‚pageè¢«æ„å»ºæˆä¸€é¢—äºŒå‰æ ‘ï¼Œå¯¹æ ‘çš„éå†é‡‡ç”¨æ·±åº¦ä¼˜å…ˆéå†ï¼Œä½†æ˜¯é€‰æ‹©å·¦èŠ‚ç‚¹è¿˜æ˜¯å³èŠ‚ç‚¹å®Œå…¨æ˜¯éšæœºçš„ã€‚

          ã€3ã€‘ å¯¹äºå°äºä¸€ä¸ªpageå†…å­˜çš„ï¼Œpageä¼šè¢«åˆ‡å‰²æˆå¤§å°ç›¸ç­‰çš„å¤šä¸ªå­˜å‚¨å—ã€‚å­˜å‚¨å—çš„å¤§å°ç”±ç¬¬ä¸€æ¬¡ç”³è¯·å†…å­˜çš„å¤§å°å†³å®š
        ğŸ™ˆ
            â‘  NioSocketChannelåˆ†æ
                å½“æœåŠ¡ç«¯æ¥æ”¶åˆ°ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯NioSocketChannelè¿æ¥æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨childEventLoopGroup()æ–¹æ³•è·å–EventLoopGroupçº¿ç¨‹ç»„
            ç”¨äºç»™NioSocketChannel åˆ†é…Reactçº¿ç¨‹EventLoopã€‚
            â‘¡ NioServerSocketChannelåˆ†æ
                é¦–å…ˆåˆ›å»ºçš„ChannelMatadataæˆå‘˜å˜é‡ï¼Œæ­¤ç±»ç”¨finalä¿®é¥°ï¼Œç„¶åå®šä¹‰ServerSocketChannelConfigç”¨äºé…ç½®ServerSocketChannelçš„tcpå‚æ•°
            é™æ€çš„newSocketæ–¹æ³•ç”¨äºé€šè¿‡ServerSocketChannelçš„open()æ‰“å¼€æ–°çš„ServerSocketChannelé€šé“ã€‚

        ğŸ™ˆ
            ChannelPipelineå’Œ ChannelHandler åˆ†æ
                Nettyçš„Channelè¿‡æ»¤å™¨å®ç°åŸç†ä¸Servlet Filteræœºåˆ¶ä¸€æ ·ï¼Œå®ƒå°†Channelçš„æ•°æ®ç®¡é“æŠ½è±¡ä¸ºChannelPipelineï¼Œæ¶ˆæ¯åœ¨ChannelPipelineä¸­æµåŠ¨å’Œä¼ é€’ã€‚

                â˜† ChannelPipeline
                       ï¼ˆ1ï¼‰å½“æœ‰æ¥æ”¶åˆ°æ•°æ®æ—¶ï¼Œåº•å±‚çš„SocketChannel#read()æ–¹æ³•è¯»å–ByteBufï¼Œè§¦å‘ChannelReadäº‹ä»¶ï¼Œ
                            ç”±çº¿ç¨‹NioEventLoopè°ƒç”¨ChannelPipeline#fireChannelRead(Object msg)æ–¹æ³•ï¼Œå°†æ¶ˆæ¯(ByteBuf)ä¼ é€’åˆ°ChannelPipelineä¸­ã€‚
                       ï¼ˆ2ï¼‰æ¶ˆæ¯ä¾æ¬¡è¢«HeadHandlerã€ChannelHandler1ã€ChannelHandler2...TailHandleræ‹¦æˆªå¤„ç†ã€‚
                       ï¼ˆ3ï¼‰å½“è°ƒç”¨ChannelHandlerContext#writæ–¹æ³•å‘é€æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯ä»TailHandlerã€ChannelHandlerN....ChannelHandler1ã€HeadHandler,æœ€ç»ˆè¢«æäº¤åˆ°æ¶ˆæ¯çš„å‘é€ç¼“å†²åŒº
                            ç­‰å¾…å±æ€§å’Œå‘é€ï¼ˆflush())
                    Nettyçš„äº‹ä»¶åˆ†ä¸ºinboundäº‹ä»¶å’Œoutboundäº‹ä»¶ã€‚
                        inboundäº‹ä»¶é€šå¸¸ç”±I/Oçº¿ç¨‹è§¦å‘ï¼Œedgï¼ŒTCP é“¾è·¯å»ºç«‹äº‹ä»¶ã€é“¾è·¯å…³é—­ï¼Œè¯»äº‹ä»¶ï¼Œå¼‚å¸¸é€šçŸ¥äº‹ä»¶ç­‰ã€‚
                        outboundäº‹ä»¶é€šå¸¸ç”±ç”¨æˆ·ä¸»åŠ¨å‘èµ·çš„ç½‘ç»œI/Oæ“ä½œï¼Œedgï¼Œ ç”¨æˆ·å‘èµ·çš„è¿æ¥æ“ä½œï¼Œç»‘å®šæ“ä½œï¼Œæ¶ˆæ¯å‘é€ç­‰æ“ä½œã€‚
                â˜† ChannelHandler

        ğŸ™ˆ
            â—† NioEventLoop è®¾è®¡åŸç†
                Nettyçš„NioEventLoopå¹¶ä¸æ˜¯ä¸€ä¸ªçº¯ç²¹çš„IOçº¿ç¨‹ï¼Œä»–é™¤äº†è´Ÿè´£IOè¯»å†™ä¹‹å¤–ï¼Œè¿˜å¤„ç†äº†ç³»ç»ŸTaskï¼ˆé€šè¿‡NioEventLoop#execute()æ–¹æ³•ï¼‰ã€å®šæ—¶ä»»åŠ¡ï¼ˆé€šè¿‡NioEventLoop#schedule()æ–¹æ³•ï¼‰ç­‰ã€‚



ã€–Httpä¸Httpsã€—
â“ ä»€ä¹ˆæ˜¯ SSL TLS HTTPS X.509ï¼Ÿ
     SNIæ¦‚è¿°ï¼š


â“‘ SSL åªèƒ½ç”¨åœ¨HTTPä¸Šå—ï¼Ÿ
â“’ Httpsåº•å±‚åŸç†ï¼Œå¯¹ç§°åŠ å¯†ä¸éå¯¹ç§°åŠ å¯†
â““ CAæœºæ„å‚ä¸ä¸CAä¼ªé€ 
â“” HTTPSçœŸçš„å®‰å…¨å—ï¼Ÿæ¨¡æ‹Ÿå¦‚ä½•ç ´è§£ï¼Ÿ


å…·ä½“ä»£ç å¯çœ‹netty_book é¡¹ç›®